<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html" charset="utf-8" />
    <title>Family Tree</title>
    <script src="family.js" type="text/javascript"></script>
    <script src="lookupTable.js"></script>
    <script src="data.js"></script>
    <style>
        .label {
            font-family: 'Arial', 'sans-serif';
            text-align: center;
            position: absolute;
            background-color: white;
            border: 2px solid black;
            border-radius: 6px;
            padding: 5px;
            cursor: pointer;
        }
        .label img { max-width: 70px; }
        .lifespan { font-size: 10pt; white-space: nowrap; }
        #control-panel {
            position: fixed;
            width: 100%;
            background: #f7f7f7;
            border-bottom: 1px solid black;
            z-index: 10;
            padding: 8px;
        }
        body { padding: 0; margin: 0; }
        .pos-root { border-color: yellow; border-width: 5px; }
        .label:hover { background: #CCF; z-index: 10; }
        .pos-ancestor { border-color: orange; border-width: 5px; }
        .text-ancestor { color: orange; }
        .pos-blood { border-color: red; border-width: 3px; }
        .text-blood { color: red; }
        .pos-descendant { border-color: olive; border-width: 5px; }
        .text-descendant { color: olive; }
        .pos-other { border-color: black; border-width: 1px; }
        .text-other { color: black; }
        .drawn-line { z-index: -1; border-width: 1px !important; }
        .label.has-info {
            background-image: url('info-icon.png');
            background-repeat: no-repeat;
            background-position: right top;
            background-size: 10px 10px;
        }
        .label:hover .info { display: block; }
        #panel-bottom ul { margin-top: 2px; margin-bottom: 2px; }
        #login-panel, #lunar-info, #subtree-input {
            text-align: center;
            margin: 10px;
        }
        #lunar-date, #reminder {
            font-size: 18px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            width: 400px;
        }
        #reminder { color: #d9534f; }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background-color: #45a049; }
    </style>
</head>
<body>
    <div id="lunar-info">
        <input type="text" id="lunar-date" readonly>
        <div id="reminder"></div>
    </div>
    <div id="login-panel">
        <p>Enter password to view the family tree:</p>
        <input type="password" id="password-input">
        <button onclick="checkPassword()">Submit</button>
        <div id="subtree-input" style="display: none;">
            <p>Or enter a Person ID for a subtree:</p>
            <input type="number" id="id-input" placeholder="e.g., 1">
            <button onclick="showSubtree()">Show Subtree</button>
        </div>
    </div>
    <div id="control-panel" style="display: none;">
        <div id="panel-top">
            <span>Family tree of <b><span id="root-name"></span></b></span>
            <span>and
                <select id="detail-picker" onchange="updateDetail()">
                    <option value="0">descendants, ancestors</option>
                    <option value="1">descendants, ancestors + their children, siblings</option>
                    <option value="2">descendants, ancestors + their grandchildren, cousins, nieces/nephews</option>
                    <option value="3">descendants, ancestors + their great-grandchildren, 2nd cousins</option>
                    <option value="Infinity" selected="selected">descendants, ancestors + all descendants of ancestors</option>
                    <option value="Everyone">everyone</option>
                </select>
            </span>
            <span id="tree-information"></span>
        </div>
        <div id="panel-bottom">
            <div id="info-pane-placeholder">
                <i>Hover your mouse on a person with <img src="info-icon.png" height="12px"> for their information</i>
                <br>See the <a target="_blank" href="https://github.com/daveagp/family-tree">source code</a> on GitHub
            </div>
            <div id="info-pane" style="display: none">About <i><span id="info-pane-name"></span></i>:
                <span id="info-pane-details"></span>
            </div>
        </div>
    </div>

    <script>
        const correctPassword = "Thuy";
        let familyData = datajs;

        function checkPassword() {
            const input = document.getElementById('password-input').value;
            if (input === correctPassword) {
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('control-panel').style.display = 'block';
                rootName = familyData[0]["Real Name"];
                showRootName();
                drawTree(window.state.divs, window.state.neighbours);
            } else {
                alert("Incorrect password!");
                document.getElementById('subtree-input').style.display = 'block';
            }
        }

        function showSubtree() {
            const id = parseInt(document.getElementById('id-input').value);
            const person = familyData.find(p => p.ID === id);
            if (person) {
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('control-panel').style.display = 'block';
                rootName = person["Real Name"];
                showRootName();
                drawTree(window.state.divs, window.state.neighbours);
            } else {
                alert("Invalid ID!");
            }
        }

        // Display today's normal and lunar date, and check for commemorations
        const today = new Date();
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const normalDate = `${months[today.getMonth()]} ${String(today.getDate()).padStart(2, '0')}, ${today.getFullYear()}`;
        const todaySolar = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
        const lunarToday = lookupTable.find(entry => entry['Ngày dương lịch'] === todaySolar);
        const lunarDateField = document.getElementById('lunar-date');
        
        if (lunarToday) {
            const [lunarDay, lunarMonth] = lunarToday['Ngày âm lịch'].split('/').slice(0, 2);
            lunarDateField.value = `Hôm nay: ${normalDate} / Ngày ${lunarDay} tháng ${lunarMonth} âm lịch${lunarToday['Tháng nhuận'] === '1' ? ' (Nhuận)' : ''}`;
        } else {
            lunarDateField.value = `Hôm nay: ${normalDate} / Ngày âm lịch không có trong bảng`;
        }

        function checkCommemorations() {
            if (!lunarToday) return; // No lunar date found for today
            const todayDay = String(lunarToday['Ngày âm lịch'].split('/')[0]).padStart(2, '0');
            const todayMonth = String(lunarToday['Ngày âm lịch'].split('/')[1]).padStart(2, '0');
            const reminderDiv = document.getElementById('reminder');
            let reminders = [];

            familyData.forEach(person => {
                if (person["Death Date (Vietnamese Lunar)"]) {
                    const [lunarDay, lunarMonth] = person["Death Date (Vietnamese Lunar)"].split('/').map(s => s.trim().padStart(2, '0')).slice(0, 2);
                    // Match only day and month, ignoring year
                    if (lunarDay === todayDay && lunarMonth === todayMonth) {
                        reminders.push(`Kỷ niệm ${person["Real Name"]} (Mất: Ngày ${lunarDay} tháng ${lunarMonth} âm lịch)`);
                    }
                }
            });

            reminderDiv.innerText = reminders.length > 0 ? reminders.join('\n') : '';
        }
        checkCommemorations();
    </script>
</body>
</html>