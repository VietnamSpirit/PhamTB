<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html" charset="utf-8" />
    <title>Family Tree</title>
    <script src="family.js" type="text/javascript"></script>
    <script src="lookupTable.js"></script>
    <script src="data.js"></script>
    <style>
        .label {
            font-family: 'Arial', 'sans-serif';
            text-align: center;
            position: absolute;
            background-color: white;
            border: 2px solid black;
            border-radius: 6px;
            padding: 5px;
            cursor: pointer;
        }
        .label img { max-width: 70px; }
        .lifespan { font-size: 10pt; white-space: nowrap; }
        #control-panel {
            width: 100%;
            background: #f7f7f7;
            border-bottom: 1px solid black;
            z-index: 10;
            padding: 8px;
            box-sizing: border-box;
        }
        body {
            padding: 0;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f0f0f0;
        }
        #lunar-date {
            font-size: 18px;
            padding: 10px;
            border: 2px solid #4682b4;
            border-radius: 8px;
            background-color: #e6f3fa;
            width: 20%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-family: 'Arial', sans-serif;
            white-space: pre-wrap;
            box-sizing: border-box;
            margin-bottom: 10px; /* Reduced gap */
        }
        .grid-container {
            display: grid;
            grid-template-columns: 3fr 1fr; /* 2 unequal columns */
            gap: 20px;
            width: 90%;
            max-width: 1200px;
            z-index: 5;
            margin-bottom: 20px; /* Space before control-panel */
        }
        #lunar-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: black;
            padding: 10px;
            border-radius: 8px;
        }
        #login-panel, #subtree-input {
            text-align: center;
            margin: 10px;
        }
        #reminder {
            font-size: 16px;
            padding: 15px;
            width: 15%;
            margin-bottom: 10px;
            color: #8b0000;
            background: linear-gradient(to bottom, #fdf6e3, #f9e8b8);
            border: 3px double #8b4513;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), inset 0 0 10px rgba(139, 69, 19, 0.1);
            font-family: 'Georgia', serif;
            white-space: pre-wrap;
            position: relative;
            overflow: hidden;
        }
        #reminder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2), transparent);
            pointer-events: none;
        }
        #candle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
        }
        .candle {
            width: 100px;
            height: auto;
        }
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1; /* Canvas behind candles */
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background-color: #45a049; }
    </style>
</head>
<body>
    
    <div class="grid-container">
        <div id="lunar-info">
            <h> Nhớ tổ tiên </h>
            <div id="candle-container">
                <img id="candle-left" class="candle" src="photos/web/0.png" alt="Candle Animation Left">
                <img class="candle" src="photos/web/bathuong.png" alt="bat huong">
                <img id="candle-right" class="candle" src="photos/web/0.png" alt="Candle Animation Right">
                <canvas id="canvas"></canvas>
                
            </div>
            <div>
                <img width=30%  src="photos/web/ban.jpg" alt="ban">
            </div>

            <div id="reminder"></div>
        </div>
        <div id="login-panel">
            <input type="text" id="lunar-date" readonly>
            <p>Enter password to view the family tree:</p>
            <input type="password" id="password-input">
            <button onclick="checkPassword()">Submit</button>
            <div id="subtree-input" style="display: none;">
                <p>Or enter a Person ID for a subtree:</p>
                <input type="number" id="id-input" placeholder="e.g., 1">
                <button onclick="showSubtree()">Show Subtree</button>
            </div>
        </div>
    </div>
    <div id="control-panel" style="display: none;">
        <div id="panel-top">
            <span>Family tree of <b><span id="root-name"></span></b></span>
            <span>and
                <select id="detail-picker" onchange="updateDetail()">
                    <option value="0">descendants, ancestors</option>
                    <option value="1">descendants, ancestors + their children, siblings</option>
                    <option value="2">descendants, ancestors + their grandchildren, cousins, nieces/nephews</option>
                    <option value="3">descendants, ancestors + their great-grandchildren, 2nd cousins</option>
                    <option value="Infinity" selected="selected">descendants, ancestors + all descendants of ancestors</option>
                    <option value="Everyone">everyone</option>
                </select>
            </span>
            <span id="tree-information"></span>
        </div>
        <div id="panel-bottom">
            <div id="info-pane-placeholder">
                <i>Hover your mouse on a person with <img src="info-icon.png" height="12px"> for their information</i>
                <br>See the <a target="_blank" href="https://github.com/daveagp/family-tree">source code</a> on GitHub
            </div>
            <div id="info-pane" style="display: none">About <i><span id="info-pane-name"></span></i>:
                <span id="info-pane-details"></span>
            </div>
        </div>
    </div>

    <script>
        const correctPassword = "Thuy";
        let familyData = datajs;

        function checkPassword() {
            const input = document.getElementById('password-input').value;
            if (input === correctPassword) {
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('control-panel').style.display = 'block';
                rootName = familyData[0]["Real Name"];
                if (typeof showRootName === 'function' && typeof drawTree === 'function' && window.state) {
                    showRootName();
                    drawTree(window.state.divs, window.state.neighbours);
                } else {
                    console.error('Family tree functions not available. Check family.js.');
                    document.body.innerHTML += '<p style="color:red;">Error: Family tree failed to load. Check console.</p>';
                }
            } else {
                alert("Incorrect password!");
                document.getElementById('subtree-input').style.display = 'block';
            }
        }

        function showSubtree() {
            const id = parseInt(document.getElementById('id-input').value);
            const person = familyData.find(p => p.ID === id);
            if (person) {
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('control-panel').style.display = 'block';
                rootName = person["Real Name"];
                if (typeof showRootName === 'function' && typeof drawTree === 'function' && window.state) {
                    showRootName();
                    drawTree(window.state.divs, window.state.neighbours);
                } else {
                    console.error('Family tree functions not available. Check family.js.');
                    document.body.innerHTML += '<p style="color:red;">Error: Family tree failed to load. Check console.</p>';
                }
            } else {
                alert("Invalid ID!");
            }
        }

        // Display today's normal and lunar date with custom format, and check for commemorations
        const today = new Date();
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const normalDate = `${months[today.getMonth()]} ${String(today.getDate()).padStart(2, '0')}, ${today.getFullYear()}`;
        const todaySolar = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
        const lunarToday = lookupTable.find(entry => entry['Ngày dương lịch'] === todaySolar);
        const lunarDateField = document.getElementById('lunar-date');

        if (lunarToday) {
            const [lunarDay, lunarMonth] = lunarToday['Ngày âm lịch'].split('/').slice(0, 2);
            lunarDateField.value = [
                'Hôm nay ',`${normalDate}`,
                ' tức mùng ',
                `${lunarDay}/${lunarMonth}${lunarToday['Tháng nhuận'] === '1' ? ' (Nhuận)' : ''}`,
                ' ', `${lunarToday['Ngày trong tuần']}`,
                ` ngày ${lunarToday['Ngày Can-Chi']}`,
                ` tháng ${lunarToday['Tháng Can-Chi']}`,
                ` năm ${lunarToday['Năm Can-Chi']}`
            ].join('\n');
        } else {
            lunarDateField.value = `${normalDate}\nNgày âm lịch không có trong bảng`;
        }

        // Check for all commemorations (no limit to number of matches, excluding photo-related fields)
        function checkCommemorations() {
            console.log('Checking commemorations...');
            console.log('Today Solar:', todaySolar);
            console.log('Lunar Today:', lunarToday);

            if (!lunarToday) {
                console.log('No lunar date found for today');
                return;
            }

            const todayDay = String(lunarToday['Ngày âm lịch'].split('/')[0]).padStart(2, '0');
            const todayMonth = String(lunarToday['Ngày âm lịch'].split('/')[1]).padStart(2, '0');
            const reminderDiv = document.getElementById('reminder');
            let reminders = [];

            console.log('Today Lunar Day:', todayDay, 'Today Lunar Month:', todayMonth);

            familyData.forEach(person => {
                if (person["Death Date (Vietnamese Lunar)"]) {
                    const [lunarDay, lunarMonth] = person["Death Date (Vietnamese Lunar)"].split('/').map(s => s.trim().padStart(2, '0')).slice(0, 2);
                    console.log(`Person: ${person["Real Name"]}, Death Date: ${lunarDay}/${lunarMonth}`);
                    if (lunarDay === todayDay && lunarMonth === todayMonth) {
                        const details = [
                            `Ngày giỗ ${person["Real Name"]}`,
                            `ID: ${person["ID"]}`,
                            `Ngày mất: ${person["Death Date (Vietnamese Lunar)"]}`,
                            `Giới tính: ${person["Sex"] === "M" ? "Nam" : "Nữ"}`,
                            `Địa chỉ: ${person["Address"]}`,
                            // Excluding "Note" as it may contain photo paths
                            `Gốc: ${person["Gốc"] || "Không có"}`,
                            `Thế hệ: ${person["Generation"]}`
                        ].join('\n');
                        reminders.push(details);
                    }
                }
            });

            console.log('Reminders found:', reminders);
            reminderDiv.innerText = reminders.length > 0 ? reminders.join('\n\n') : 'Không có ngày giỗ hôm nay';
        }
        checkCommemorations();

        // Candle and particle animation script
        let candleIndex = 0;
        const candleFrames = [
            "photos/web/0.png", "photos/web/1.png", "photos/web/2.png", "photos/web/3.png", 
            "photos/web/4.png", "photos/web/5.png", "photos/web/6.png", "photos/web/7.png", 
            "photos/web/8.png", "photos/web/2.png", "photos/web/1.png"
        ];
        function animateCandle() {
            candleIndex = (candleIndex + 1) % candleFrames.length;
            document.getElementById("candle-left").src = candleFrames[candleIndex];
            document.getElementById("candle-right").src = candleFrames[candleIndex];
        }
        setInterval(animateCandle, 200);

        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        let W = window.innerWidth;
        let H = window.innerHeight;
        canvas.width = W;
        canvas.height = H;

        let particles = [];
        for (let i = 0; i < 80; i++) {
            particles.push({
                x: Math.random() * W,
                y: Math.random() * H,
                r: Math.random() * 3 + 1,
                d: Math.random() * 80
            });
        }

        function draw() {
            ctx.clearRect(0, 0, W, H);
            ctx.fillStyle = "white";
            ctx.beginPath();
            for (let i = 0; i < particles.length; i++) {
                let p = particles[i];
                ctx.moveTo(p.x, p.y);
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2, true);
            }
            ctx.fill();
            update();
        }

        function update() {
            for (let i = 0; i < particles.length; i++) {
                let p = particles[i];
                p.y += Math.cos(p.d) + 1 + p.r / 2;
                p.x += Math.sin(p.d) * 2;
                if (p.x > W || p.x < 0 || p.y > H) {
                    particles[i] = { x: Math.random() * W, y: -10, r: p.r, d: p.d };
                }
            }
        }
        setInterval(draw, 40);
    </script>
</body>
</html>