<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html" charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Mobile-friendly viewport -->
    <title>Family Tree</title>
    <script src="family.js" type="text/javascript"></script>
    <script src="lookupTable.js"></script>
    <script src="data.js"></script>
    <style>
        .label {
            font-family: 'Arial', 'sans-serif';
            text-align: center;
            position: absolute;
            background-color: white;
            border: 2px solid black;
            border-radius: 6px;
            padding: 5px;
            cursor: pointer;
        }
        .label img { max-width: 70px; }
        .lifespan { font-size: 10pt; white-space: nowrap; }
        #control-panel {
            width: 100%;
            background: #f7f7f7;
            border-bottom: 1px solid black;
            z-index: 10;
            padding: 8px;
            box-sizing: border-box;
        }
        body {
            padding: 0;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f0f0f0;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        #lunar-date {
            font-size: 18px;
            padding: 10px;
            border: 2px solid #4682b4;
            border-radius: 8px;
            background-color: #e6f3fa;
            width: 25%; /* Base width */
            max-width: 300px; /* Cap for larger screens */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-family: 'Arial', sans-serif;
            white-space: normal; /* Wrap text */
            word-wrap: break-word; /* Break long words */
            overflow-wrap: break-word; /* Ensure wrapping on all browsers */
            box-sizing: border-box;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 15; /* Above other elements */
        }
        .grid-container {
            display: grid;
            grid-template-columns: 3fr 1fr; /* Flexible unequal columns */
            gap: 2vw; /* Responsive gap */
            width: 90%;
            max-width: 1200px;
            z-index: 5;
            margin: 60px auto 20px auto; /* Space for lunar-date at top */
        }
        #lunar-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: black;
            padding: 10px;
            border-radius: 8px;
            width: 100%; /* Ensure it fills its grid cell */
            box-sizing: border-box;
        }
        #lunar-info p, #lunar-info h2 {
            color: white; /* Visible on black background */
            margin: 0 0 10px 0;
            text-align: center;
            white-space: normal; /* Wrap text */
            word-wrap: break-word; /* Break long words if needed */
            width: 100%; /* Full width within container */
        }
        #login-panel, #subtree-input {
            text-align: center;
            margin: 10px;
            position: relative; /* Ensure it’s in the flow */
            z-index: 10; /* Above other elements but below lunar-date */
        }
        #vi-thien-toi-lac {
            font-size: 18px;
            padding: 5px;
            width: 100%; /* Full width within parent */
            max-width: 200px; /* Cap for larger screens */
            margin-bottom: 5px;
            color: #8b0000;
            background: linear-gradient(to bottom, #fdf6e3, #f9e8b8);
            border: 3px double #8b4513;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), inset 0 0 10px rgba(139, 69, 19, 0.1);
            font-family: 'Georgia', serif;
            text-align: center; /* Center text like reminder */
        }
        #reminder, #vi-thien-toi-lac {
            font-size: 16px;
            padding: 15px;
            width: 100%; /* Full width within parent */
            max-width: 200px; /* Cap for larger screens */
            margin-bottom: 10px;
            color: #8b0000;
            background: linear-gradient(to bottom, #fdf6e3, #f9e8b8);
            border: 3px double #8b4513;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), inset 0 0 10px rgba(139, 69, 19, 0.1);
            font-family: 'Georgia', serif;
            white-space: normal; /* Wrap text */
            box-sizing: border-box;
            text-align: center; /* Center text like reminder */
        }
        #reminder::before, #vi-thien-toi-lac::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2), transparent);
            pointer-events: none;
        }
        #candle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap; /* Wrap on small screens */
        }
        .candle {
            width: 100px;
            height: auto;
            max-width: 100%; /* Responsive image scaling */
        }
        #ban-container {
            display: flex;
            justify-content: center; /* Center horizontally */
            width: 100%; /* Full width of parent */
            margin-bottom: 10px;
        }
        #ban-image {
            width: 100%; /* Independent width */
            max-width: 300px; /* Fixed cap, not matching reminder */
            height: auto;
            max-height: calc(50% * 300px); /* Half height based on width */
            object-fit: cover; /* Maintain aspect ratio */
        }
        #donation-box {
            margin: 10px 0;
            text-align: center;
        }
        #donation-box img {
            width: 100%;
            max-width: 150px; /* Reasonable size for QR code */
            height: auto;
        }
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1; /* Canvas behind candles */
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%; /* Full width on mobile */
            max-width: 200px; /* Cap for larger screens */
            margin: 5px auto;
        }
        button:hover { background-color: #45a049; }
        input[type="password"] {
            padding: 8px;
            font-size: 16px;
            width: 100%;
            max-width: 200px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        /* Mobile-friendly adjustments */
        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr; /* Stack columns on mobile */
                gap: 10px;
                margin-top: 80px; /* Adjust for lunar-date */
            }
            #lunar-date {
                font-size: 16px; /* Slightly smaller text */
                padding: 8px;
                width: 90%; /* Full width on mobile */
                max-width: 250px;
                right: 5px;
                top: 5px;
            }
            #reminder, #vi-thien-toi-lac {
                font-size: 14px;
                padding: 10px;
                width: 90%; /* Slightly less than full width */
                max-width: 180px; /* Adjusted for mobile */
            }
            #ban-image {
                width: 90%; /* Independent on mobile */
                max-width: 270px; /* Slightly smaller cap for mobile */
                max-height: calc(50% * 270px); /* Half height on mobile */
            }
            #donation-box img {
                max-width: 120px; /* Smaller QR code on mobile */
            }
            .candle {
                width: 80px; /* Smaller candles on mobile */
            }
            button {
                padding: 6px 12px;
                font-size: 14px;
            }
            #lunar-info, #login-panel {
                padding: 5px; /* Reduce padding */
            }
        }
    </style>
</head>
<body>
    <input type="text" id="lunar-date" readonly>
    <div class="grid-container">
        <div id="lunar-info">
            <h2>Nhớ tổ tiên</h2>
            <div id="vi-thien-toi-lac">VI THIỆN TỐI LẠC</div>
            <div id="candle-container">
                <img id="candle-left" class="candle" src="photos/web/0.png" alt="Candle Animation Left">
                <img class="candle" src="photos/web/bathuong.png" alt="bat huong">
                <img id="candle-right" class="candle" src="photos/web/0.png" alt="Candle Animation Right">
                <canvas id="canvas"></canvas>
            </div>
            <div id="ban-container">
                <img id="ban-image" src="photos/web/ban.jpg" alt="ban">
            </div>
            <div id="reminder"></div>
        </div>
        <div id="donation-box">
            <h1>Ky Trong Vo Song Fundraising 2025</h1>
            <p>Quỹ bảo tồn văn hoá lịch sử hai làng Kỳ Trọng và Vô Song. Dự án do cá nhân tổ chức nhằm hỗ trợ hoạt động cung cấp tư liệu văn hoá lịch sử và hỗ trợ khuyến học cho con cháu Kỳ Trọng Vô Song </p>
            <p>Support via Bank transfer:</p>
            <img src="photos/web/qrcode.png" alt="PayPal Donation QR Code">
            <p>Support via PayPal, Card:</p>
            <img src="photos/web/Paypal.png" alt="PayPal Donation QR Code">
            <div id="login-panel">
                <p>Enter password to view the family tree:</p>
                <input type="password" id="password-input" onkeydown="if (event.key === 'Enter') checkPassword()">
                <button onclick="checkPassword()">Submit</button>
                <div id="subtree-input" style="display: none;">
                    <p>Or enter a Person ID for a subtree:</p>
                    <input type="number" id="id-input" placeholder="e.g., 1" onkeydown="if (event.key === 'Enter') showSubtree()">
                    <button onclick="showSubtree()">Show Subtree</button>
                </div>
            </div>
        </div>
    </div>
    <div id="control-panel" style="display: none;">
        <div id="panel-top">
            <span>Family tree of <b><span id="root-name"></span></b></span>
            <span>and
                <select id="detail-picker" onchange="updateDetail()">
                    <option value="0">descendants, ancestors</option>
                    <option value="1">descendants, ancestors + their children, siblings</option>
                    <option value="2">descendants, ancestors + their grandchildren, cousins, nieces/nephews</option>
                    <option value="3">descendants, ancestors + their great-grandchildren, 2nd cousins</option>
                    <option value="Infinity" selected="selected">descendants, ancestors + all descendants of ancestors</option>
                    <option value="Everyone">everyone</option>
                </select>
            </span>
            <span id="tree-information"></span>
        </div>
        <div id="panel-bottom">
            <div id="info-pane-placeholder">
                <i>Hover your mouse on a person with <img src="info-icon.png" height="12px"> for their information</i>
            </div>
            <div id="info-pane" style="display: none">About <i><span id="info-pane-name"></span></i>:
                <span id="info-pane-details"></span>
            </div>
        </div>
    </div>

    <script>
        const correctPassword = "Thuy";

        function checkPassword() {
            const input = document.getElementById('password-input').value;
            if (input === correctPassword) {
                window.location.href = "giapha.html";
            } else {
                alert("Incorrect password!");
                document.getElementById('subtree-input').style.display = 'block';
            }
        }

        function showSubtree() {
            const id = parseInt(document.getElementById('id-input').value);
            if (id && datajs.some(p => p.ID === id)) {
                window.location.href = `giapha.html?id=${id}`;
            } else {
                alert("Invalid ID!");
            }
        }

        // Display today's normal and lunar date with custom format, and check for commemorations
        const today = new Date();
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const normalDate = `${months[today.getMonth()]} ${String(today.getDate()).padStart(2, '0')}, ${today.getFullYear()}`;
        const todaySolar = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
        const lunarToday = lookupTable.find(entry => entry['Ngày dương lịch'] === todaySolar);
        const lunarDateField = document.getElementById('lunar-date');

        if (lunarToday) {
            const [lunarDay, lunarMonth] = lunarToday['Ngày âm lịch'].split('/').slice(0, 2);
            lunarDateField.value = [
                'Hôm nay ',`${normalDate}`,
                ' tức mùng ',
                `${lunarDay}/${lunarMonth}${lunarToday['Tháng nhuận'] === '1' ? ' (Nhuận)' : ''}`,
                ' ', `${lunarToday['Ngày trong tuần']}`,
                ` ngày ${lunarToday['Ngày Can-Chi']}`,
                ` tháng ${lunarToday['Tháng Can-Chi']}`,
                ` năm ${lunarToday['Năm Can-Chi']}`
            ].join('\n');
        } else {
            lunarDateField.value = `${normalDate}\nNgày âm lịch không có trong bảng`;
        }

        // Check for all commemorations (no limit to number of matches, including "Note" but excluding photo paths)
        function checkCommemorations() {
            console.log('Checking commemorations...');
            console.log('Today Solar:', todaySolar);
            console.log('Lunar Today:', lunarToday);

            if (!lunarToday) {
                console.log('No lunar date found for today');
                return;
            }

            const todayDay = String(lunarToday['Ngày âm lịch'].split('/')[0]).padStart(2, '0');
            const todayMonth = String(lunarToday['Ngày âm lịch'].split('/')[1]).padStart(2, '0');
            const reminderDiv = document.getElementById('reminder');
            let reminders = [];

            console.log('Today Lunar Day:', todayDay, 'Today Lunar Month:', todayMonth);

            datajs.forEach(person => {
                if (person["Death Date (Vietnamese Lunar)"]) {
                    const [lunarDay, lunarMonth] = person["Death Date (Vietnamese Lunar)"].split('/').map(s => s.trim().padStart(2, '0')).slice(0, 2);
                    console.log(`Person: ${person["Real Name"]}, Death Date: ${lunarDay}/${lunarMonth}`);
                    if (lunarDay === todayDay && lunarMonth === todayMonth) {
                        let note = person["Note"] || "Không có";
                        if (note.includes("Photos/")) {
                            note = note.replace(/Photos\/[^|\s]+/g, '').trim();
                            note = note || (person["Note"] && person["Note"].replace(/Photos\/[^|\s]+/g, '').trim()) || "Không có";
                        }
                        const details = [
                            `Ngày giỗ cụ ${person["Real Name"]}`,
                            `ID: ${person["ID"]}`,
                            `Ngày mất: ${person["Death Date (Vietnamese Lunar)"]}`,
                            `Giới tính: ${person["Sex"] === "M" ? "Nam" : "Nữ"}`,
                            `Địa chỉ: ${person["Address"]}`,
                            `Ghi chú: ${note}`,
                            `Gốc: ${person["Gốc"] || "Không có"}`,
                            `Thế hệ: ${person["Generation"]}`
                        ].join('\n');
                        reminders.push(details);
                    }
                }
            });

            console.log('Reminders found:', reminders);
            reminderDiv.innerText = reminders.length > 0 ? reminders.join('\n\n') : 'Không có ngày giỗ hôm nay';
        }
        checkCommemorations();

        // Candle and particle animation script
        let candleIndex = 0;
        const candleFrames = [
            "photos/web/0.png", "photos/web/1.png", "photos/web/2.png", "photos/web/3.png", 
            "photos/web/4.png", "photos/web/5.png", "photos/web/6.png", "photos/web/7.png", 
            "photos/web/8.png", "photos/web/2.png", "photos/web/1.png"
        ];
        function animateCandle() {
            candleIndex = (candleIndex + 1) % candleFrames.length;
            document.getElementById("candle-left").src = candleFrames[candleIndex];
            document.getElementById("candle-right").src = candleFrames[candleIndex];
        }
        setInterval(animateCandle, 200);

        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        let W = window.innerWidth;
        let H = window.innerHeight;
        canvas.width = W;
        canvas.height = H;

        let particles = [];
        for (let i = 0; i < 80; i++) {
            particles.push({
                x: Math.random() * W,
                y: Math.random() * H,
                r: Math.random() * 3 + 1,
                d: Math.random() * 80
            });
        }

        function draw() {
            ctx.clearRect(0, 0, W, H);
            ctx.fillStyle = "white";
            ctx.beginPath();
            for (let i = 0; i < particles.length; i++) {
                let p = particles[i];
                ctx.moveTo(p.x, p.y);
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2, true);
            }
            ctx.fill();
            update();
        }

        function update() {
            for (let i = 0; i < particles.length; i++) {
                let p = particles[i];
                p.y += Math.cos(p.d) + 1 + p.r / 2;
                p.x += Math.sin(p.d) * 2;
                if (p.x > W || p.x < 0 || p.y > H) {
                    particles[i] = { x: Math.random() * W, y: -10, r: p.r, d: p.d };
                }
            }
        }
        setInterval(draw, 40);
    </script>
</body>
</html>